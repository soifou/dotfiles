#!/usr/bin/env sh

for i in xob wpctl; do
    [ ! "$(command -v $i)" ] && {
        echo "Error: prerequisite $i not found in PATH" >&2
        exit 1
    }
done

VOLUME_PIPE=/tmp/xob-vol.fifo

_clean() {
    [ -p "$VOLUME_PIPE" ] && {
        fuser -TERM -s -k "$VOLUME_PIPE"
        rm -f "$VOLUME_PIPE"
    }
}

_start() {
    _clean "$VOLUME_PIPE"
    mkfifo "$VOLUME_PIPE"
    tail -f "$VOLUME_PIPE" | xob -q &
}

_update() {
    [ -p "$VOLUME_PIPE" ] && {
        VOL=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ | awk '{print $2*100}')
        [ -n "$(wpctl get-volume @DEFAULT_AUDIO_SINK@ | awk '{print $3}')" ] && VOL="$VOL!"
        echo "$VOL" >> $VOLUME_PIPE
    }
}

case "$1" in
    -u) _update ;;
    -c) _clean ;;
    *) _start ;;
esac
