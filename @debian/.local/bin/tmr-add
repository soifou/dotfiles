#!/usr/bin/env sh

# Mimeapp script for adding torrent to transmission-daemon
# Handle magnets and torrent links as well.
# Start the daemon first if not running.

# No argument? Exit
[ -z "$1" ] && { exit; }

_n() {
    notify-send -i transmission Transmission "$1"
}

case "$1" in
*magnet:*) MAGNET=$1 ;;
*http*)
    TMPFILE=$(mktemp)
    curl -sL "$1" >"$TMPFILE"
    case $(file --mime-type "$TMPFILE" -bL) in
        # convert torrent file to magnet link
        application/x-bittorrent) MAGNET=$(transmission-show -m "$TMPFILE" | sed -e 's/&tr.*//g') ;;
        *) _n "Not a torrent file..." && exit ;;
    esac
    rm -f "$TMPFILE"
    ;;
*)
    _n "Don't know how to handle \"$1\""
    exit
    ;;
esac

# transmission-daemon sometimes fails to take remote requests in its first moments.
pgrep -x transmission-da || (transmission-daemon && _n "Starting daemon..." && sleep 3)
transmission-remote -a "$MAGNET" && _n "Torrent added."
