#!/usr/bin/env sh

VOLUME_PIPE=/tmp/xob-vol.fifo

# Requirements: pulseaudio-utils (pactl)
# TODO: migrate to pw-cli (pipewire)
# https://gitlab.freedesktop.org/pipewire/pipewire/-/wikis/Migrate-PulseAudio#sinksource-port-volumemuteport-latency

_clean() {
    [ -p "$1" ] && {
        fuser -TERM -s -k "$1"
        rm -f "$1"
    }
}

_start() {
    _clean "$1"
    mkfifo "$1"
    tail -f "$1" | xob -q &
    echo "" >"$1"
}

_update() {
    pgrep -x xob >/dev/null && {
        VOL=$(pactl get-sink-volume @DEFAULT_SINK@ | awk '{print $5}' | sed 's/[%|,]//g')
        [ "$(pactl get-sink-mute @DEFAULT_SINK@ | awk '{print $2}')" = "yes" ] && VOL="$VOL!"
        echo "$VOL" >>$VOLUME_PIPE
    }
}

case "$1" in
    -u) _update ;;
    *) _start "$VOLUME_PIPE" ;;
esac
