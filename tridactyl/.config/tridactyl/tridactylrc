" Reset all previous settings
sanitize tridactyllocal tridactylsync

" Settings {{{
" Sourcing several files is quite slow
" source_quiet ~/.config/tridactyl/foo

" Use my startpage on new tabs
" set newtab file:///home/user/startpage/index.html

" set hintdelay 100

" Make Tridactyl work on more sites at the expense of some security
" set csp clobber

" Make Tridactyl work on addons.mozilla.org
" fixamo_quiet

" Custom theme generated by pywal
colorscheme wal

" Disable indicator in normal mode
set modeindicatormodes {"normal":"false","insert":"true","input":"true","ignore":"true","ex":"true","hint":"true","visual":"true"}
" }}}

" Autocommands {{{
" Prevent website from stealing focus
" set allowautofocus false
autocmd TabEnter .* unfocus

" Skip 'home' page for youtube channel and go straight to 'video'
autocmd DocStart .*youtube\.com/(c|channel|user)/[^/]*/?$ urlmodify -g 2 videos
autocmd UriChange .*youtube\.com js window.location.href.match(".*youtube\.com/(c|channel|user)/[^/]*/?$") && tri.excmds.urlmodify("-g", "2", "videos")

" Front-end alternatives (disabled - use more convenient ff extension https://libredirect.github.io)
" autocmd DocStart ^http(s?)://www\.youtube\.com urlmodify -t www.youtube.com yewtu.be
" }}}

" Follow links {{{
" Optimize follow link for URL's.
bindurl duckduckgo.com f hint -Jc [data-testid="result-title-a"]
bindurl duckduckgo.com F hint -Jbc [data-testid="result-title-a"]
bindurl giphy.com f hint -Jci a > img
bindurl youtube.com f hint -Jw
bindurl youtube.com t hint -J
" }}}

" Containers {{{
autocontain -s google\.(fr|com) google
autocontain -s youtube\.com google
autocontain -s amazon\.(fr|com) amazon
" }}}

" Quickmark {{{
" Use go<key>/gn<key>/gw<key> to open quickmark for <key>
" in (o) current / (n) new / (w) window
" quickmark g https://github.com/
" }}}

" Blacklist {{{
blacklistadd calendar.google.com
blacklistadd docs.google.com
blacklistadd drive.google.com
blacklistadd mail.google.com
blacklistadd monkeytype.com
blacklistadd typingclub.com
" }}}

" Searchurls {{{
" Disable all built-in searchurls
" jsb Object.keys(tri.config.get("searchurls")).forEach(u => tri.config.set("searchurls", u, '""'))

" Set DuckDuckGo as default search engine
" ie: o tridactyl will show results from duckduckgo
set searchengine duckduckgo

" Enhance search
" ie. search tridactyl on github: o gh tridactyl
set searchurls.amazon https://www.amazon.fr/s/ref=nb_sb_noss?field-keywords=%s
set searchurls.arch https://wiki.archlinux.org/index.php?search=%s&title=Special%3ASearch&go=Go
set searchurls.gh https://github.com/search?utf8=%E2%9C%93&q=%s&ref=simplesearch&type=code
set searchurls.gr https://github.com/search?utf8=%E2%9C%93&q=%s&ref=simplesearch&type=repositories
set searchurls.gi https://github.com/search?utf8=%E2%9C%93&q=%s&ref=simplesearch&type=issues
set searchurls.gist https://gist.github.com/search?q=%s
set searchurls.maps https://www.google.com/maps/search/%s
set searchurls.imdb https://www.imdb.com/find?q=%s
set searchurls.mdn https://developer.mozilla.org/en-US/search?q=%s&topic=api&topic=js
set searchurls.npm https://www.npmjs.com/search?q=%s
set searchurls.tre https://www.wordreference.com/redirect/translation.aspx?w=%s&dict=enfr
set searchurls.trf https://www.wordreference.com/redirect/translation.aspx?w=%s&dict=fren
set searchurls.w https://en.wikipedia.org/w/index.php?search=%s&title=Special%3ASearch
set searchurls.wfr https://fr.wikipedia.org/w/index.php?search=%s&title=Sp%E9cial%3ARecherche
set searchurls.y https://yewtu.be/results?search_query=%s
set searchurls.yi https://piped.privacydev.net/results?search_query=%s
set searchurls.rp https://teddit.artemislena.eu/r/all/search?q=%s
" }}}

" Zoom {{{
" Increase automatically zoom level for some websites
" Note this can be annoying when restoring a Firefox session
" with numerous pinned tabs, causing back and forth zoom level
" on the current one.
" Adding theses Firefox prefs disable reload of previous tabs:
"   browser.sessionstore.restore_on_demand => true
"   browser.sessionstore.restore_pinned_tabs_on_demand => true

autocmd DocStart .* zoom 120

" autocmd DocStart .*archlinux\.org.* zoom 120
" autocmd DocStart .*duckduckgo\.com.* zoom 120
" autocmd DocStart .*github\.com.* zoom 120
" autocmd DocStart .*gitlab\.com.* zoom 120
" autocmd DocStart .*wikipedia\.org.* zoom 120
" autocmd DocStart .stackoverflow\.com.* zoom 120
" }}}

" Keybinds {{{
" Default keybinds: https://github.com/tridactyl/tridactyl/blob/master/src/lib/config.ts

" Reload conf on the fly
bind ,s source ~/.config/tridactyl/tridactylrc

bind ? help

" Open command prompt
unbind :
bind ,; fillcmdline_notrail
" Allow to copy in the commandline
unbind --mode=ex <C-c>
" Like Doom Emacs
bind --mode=ex <C-i> ex.next_completion
bind --mode=ex <C-d> ex.prev_completion
bind --mode=ex <C-k> ex.prev_history
bind --mode=ex <C-j> ex.next_history
bind --mode=ex <C-h> !s xdotool key --clearmodifiers Left
bind --mode=ex <C-l> !s xdotool key --clearmodifiers Right

" Navigation
unbind H
unbind J
unbind K
unbind L

bind h back
bind l forward
bind gu urlparent
bind gU urlroot

bind H scrollpx -45
bind L scrollpx +45

bind J zoom 0.1 true
bind K zoom -0.1 true

bind [ tabprev
bind ] tabnext

bind { followpage prev
bind } followpage next

bind <C-o> jumpprev
bind <C-i> jumpnext

" bind g; changelistjump -1
" bind g, changelistjump 1

bind --mode=insert <C-i> focusinput -n
bind --mode=insert <C-d> focusinput -N

bind << tabmove -1
bind >> tabmove +1

" Find in page
bind / fillcmdline find
bind ? fillcmdline find -?
bind n findnext --search-from-view
bind N findnext --search-from-view --reverse
bind p findnext --search-from-view --reverse
bind <C-l> nohlsearch
set findcase smart

" Emulate arrow keys in insert mode
bind --mode=insert <C-h> !s xdotool key --clearmodifiers Left
bind --mode=insert <C-j> !s xdotool key Down
bind --mode=insert <C-k> !s xdotool key Up
bind --mode=insert <C-l> !s xdotool key --clearmodifiers Right

" Play video with mpv
 " unbind v
unbind V
" On current URL
bind V composite get_current_url | exclaim_quiet mpv
" Using hint
" bind v hint -JW mpv
bindurl youtube.com v composite hint -Jpipe ytd-thumbnail>a href | exclaim_quiet mpv
bindurl yewtu.be v composite hint -Jpipe video-card-row>a href | exclaim_quiet mpv
bindurl dailymotion.com v composite hint -Jpipe a href | exclaim_quiet mpv

" Open link in foreground tab
bind ,f hint -t
" Open link in background tab
bind F hint -b
" Open link in new window
bind w hint -w
" Yank link to clipboard
bind ,y hint -y

" Open in reader mode
" bind --mode=normal ,q composite hint -pipe a href | jsb -p tri.excmds.tabopen("about:reader?url=" + JS_ARG)

" RSS (show feeds in current page and prompt if more than one found)
alias rsssave js -p tri.excmds.shellescape(JS_ARG).then(url => tri.excmds.exclaim_quiet('echo ' + url + ' >> ~/.config/newsboat/urls; notify-send -i RSS_feeds Newsboat Subscribed'))
set rsscmd rsssave %u
bind ,r composite rssexec
" Subscribe to YouTube channels too
alias ytrss js -p tri.excmds.shellescape(JS_ARG).then(url => tri.excmds.exclaim_quiet('yt-rss ' + url + ' >> ~/.config/newsboat/urls'))
bindurl youtube.com n composite get_current_url | ytrss

" Editor
" Focus an input field, then <C-e> (default <C-i>)
" will start vim instance with content of the input (or blank)
set editorcmd kitty --class floating $EDITOR %f
bind --mode=insert <C-e> editor
bind --mode=input <C-e> editor
" Uncomment to trigger editor directly on focus
" bind --mode=normal gi composite focusinput -l | editor

" Toggle pinned tab
bind ,p pin

" Git{Hub,Lab} git clone via SSH yank
bind yg composite js "git clone " + document.location.href.replace(/https?:\/\//,"git@").replace("/",":").replace(/$/,".git") | clipboard yank
" }}}

" vim: foldmethod=marker foldlevel=0 foldnestmax=1
