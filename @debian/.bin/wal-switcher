#!/bin/sh

# Custom rofi script to change wallpaper and scheme generated by pywal.
# Credits to ilsenatorov for the idea

XRANDR_BIN="$(whereis -b xrandr | awk '{print $2}')"
if [ -z "$XRANDR_BIN" ]; then
    echo missing xrandr, please install dependencies
    exit 1
fi

WALLPAPER_PATH=${WALLPAPER_PATH:-~/Pictures/wallpapers}
mkdir -p "$WALLPAPER_PATH"

if [ -z "$@" ]; then
    get_themes() {
        ls "$WALLPAPER_PATH"
    }
    echo random
    get_themes
else
    THEMES="$@"

    # rm -rf ${XDG_CACHE_HOME:-~/.cache}/wal

    # fetch random wallpaper from unsplash
    if [ x"random" = x"${THEMES}" ]; then
        SCREEN_RES=$($XRANDR_BIN | awk '/ primary/{print $4}' | sed -e 's/+.*//g')
        THEMES="today"
        rm -f "$WALLPAPER_PATH/today"
        curl -o "$WALLPAPER_PATH/${THEMES}" -J -L "https://source.unsplash.com/random/$SCREEN_RES" >/dev/null 2>&1
    else
        ln -sf "$WALLPAPER_PATH/${THEMES}" "$WALLPAPER_PATH/today"
    fi

    # generate schemes based on selected wallpaper
    if [ -n "${THEMES}" ]; then
        rm -rf "$XDG_CACHE_HOME/wal"
        wal -o ~/.bin/wal-changer -q -n -i "$WALLPAPER_PATH/${THEMES}" >/dev/null
    fi
fi
